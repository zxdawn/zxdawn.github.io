_id: 8cebf640-f357-11ea-984d-7def0fb83a92
_parent: Initializing-the-WRF-model-with-ERA5
reply_to: 86ec91c0-f1ca-11ea-a117-4914f65d6c87
botpot: ''
name: Ray
email: fe1ebf9ed20a33f87e91fbcdc6b1c304
body: "Hi Xin,\r\n\r\nRe using reduced number f model levels, see script below (amend to suit: FILEIN and LEVEL_MIN. Run this on the raw model level data file (not the surface data file). It handles the conversion to GRIB1 and PV issue. Note that if you extract only ml from (say) 45-137 you still need to extract the orography and LogPs at ml=1 i.e. amend your retrieval. You also need a new list of A,B values. Easiest way to get this is simply run, assuming you use ml starting from 45,\r\ntail -n +45 List_A_B_Values.wrf.full | cut -d\" \" -f2- | nl -v0 | sed 's/^ *//'  >List_A_B_Values.wrf.new\r\n\r\nNo changes are required fro the surface (non ml) data, apart from GRIB1 conversion etc.\r\n\r\nRun the script to get processed ml data:\r\n\r\n#!/bin/sh\r\n#\r\nFILEIN=dummy.grb  # the input file - the raw ml (GRIB2) ERA5 data from archive\r\n[ -s \"$FILEIN\" ] || { echo \"** $FILEIN does not exist or size zero .. \"; exit 1; }\r\n\r\nLEVEL_MIN=45  # i.e. we have retrieved levels 45-137 to save space\r\n\r\n[ $LEVEL_MIN -le 1 ] && { echo \"** ml starting at 1?? - nothing to do!\"; exit 0; }\r\n\r\ncat >filter_levels <<eof\r\nwrite \"$$_[indicatorOfParameter]_[levelType]_[level]\";\r\neof\r\n\r\n# Transform to GRIB1 and fix issue with PV\r\n\r\ngrib_set -r -s packingType=grid_simple $FILEIN $$.grb || \\\r\n{ echo \"** grib_set packing failed ...\"; rm -f $$.grb; exit 1; }\r\ngrib_set -s deletePV=1,edition=1 $$.grb ${FILEIN}.$$ || \\\r\n{ echo \"** grib_set pv failed ...\"; rm -f ${FILEIN}.$$; exit 1; }\r\nrm -f $$.grb\r\nFILE=${FILEIN}.$$\r\n\r\n\r\n# Split file into single GRIB files\r\n\r\ntrap '/bin/rm -f $$_*_*_* filter_levels' 0 1 2 3 6 15\r\n\r\ngrib_filter filter_levels \"$FILE\" || \\\r\n{ echo \"** grib_filter failed ...\"; exit 1; }\r\nrm -f $FILE\r\n\r\n# Sanity check\r\n[ -s \"$$_t_ml_1\" ] && \\\r\n{ echo \"** It looks like your file has model levels from 1 .. nothing to do!\"; exit 0; }\r\n\r\n# reset model levels to start at 1 (but leave sfcheight/sfcgeopotential/logPs alone)\r\n\r\nLEVEL_MIN=$((LEVEL_MIN - 1))\r\n\r\nfor file in $$_*_*_*\r\ndo\r\nLEVEL=${file##*_}\r\nif [ \"$LEVEL\" -ne 1 ]\r\nthen\r\nLEVEL_NEW=$((LEVEL - LEVEL_MIN))\r\n#echo $LEVEL $LEVEL_NEW $file\r\n\r\ngrib_set -r -s level=$LEVEL_NEW $file ${file}.$$ || \\\r\n{ echo \"** grib_set failed ...\"; rm -f ${file}.$$; exit 1; }\r\nmv ${file}.$$ $file\r\nfi\r\ndone\r\n\r\n# Merge files (note that WRF expects files ordered by date/time)\r\nrm -f ${FILEIN}.reset_ml\r\ngrib_copy -B'dataTime:i asc' $$_*_*_* ${FILEIN}.reset_ml || \\\r\n{ echo \"** failed to merge files ...\"; rm -f ${FILEIN}.reset_ml; exit 1; }\r\necho \"** Adjusted file: ${FILEIN}.reset_ml\"\r\nexit"
date: '2020-09-10T11:19:54.200Z'
