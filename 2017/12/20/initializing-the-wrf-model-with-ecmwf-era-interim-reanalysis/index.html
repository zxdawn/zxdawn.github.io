<!doctype html><html lang=zn-hans><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no,maximum-scale=1"><meta name=author content="Xin Zhang"><meta name=description content="Summarization

To summarise, you need three separate data files from the reanalysis data:

Pressure level data (or model levels)
Surface variable data
Fixed data.

"><meta property="og:title" content="Initializing the WRF model with ECMWF ERA-Interim reanalysis"><meta property="og:description" content="Summarization

To summarise, you need three separate data files from the reanalysis data:

Pressure level data (or model levels)
Surface variable data
Fixed data.

"><meta property="og:type" content="article"><meta property="og:url" content="https://zxdawn.github.io/2017/12/20/initializing-the-wrf-model-with-ecmwf-era-interim-reanalysis/"><meta property="article:section" content="sci-tech"><meta property="article:published_time" content="2017-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2017-12-20T00:00:00+00:00"><title>Initializing the WRF model with ECMWF ERA-Interim reanalysis | Dreambooker</title><link rel=canonical href=https://zxdawn.github.io/2017/12/20/initializing-the-wrf-model-with-ecmwf-era-interim-reanalysis/><link href=https://zxdawn.github.io/vendors/fontawesome-free-5.14.0-web/css/all.min.css rel=stylesheet><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:300,400,500,600"><link href=https://zxdawn.github.io/css/font.css rel=stylesheet><link href=https://zxdawn.github.io/css/vendors/bootstrap4/bootstrap.min.css rel=stylesheet><link href=https://zxdawn.github.io/css/vendors-extensions/mdb/mdb.min.css rel=stylesheet><link href=https://zxdawn.github.io/css/vendors/mdb/style.min.css rel=stylesheet><link href=https://zxdawn.github.io/css/main.css rel=stylesheet><link rel="shortcut icon" href=https://zxdawn.github.io/img/logo.jpg><style type=text/css>@media(min-width:800px) and (max-width:850px){.navbar:not(.top-nav-collapse){background:#1c2331!important}}</style><link rel=stylesheet href=https://zxdawn.github.io/css/vendors/highlight/github-gist.css></head><body class=bg-light data-spy=scroll data-target=#page-scrollspy data-offset=90><nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class=container><a class=navbar-brand href=https://zxdawn.github.io><img class=avatar src=https://zxdawn.github.io/img/logo.jpg style=width:40px!important;height:auto class="d-inline-block align-top" alt>
<strong>Xin Zhang</strong></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=https://zxdawn.github.io>Home</a></li><li class=nav-item><a class=nav-link href=https://zxdawn.github.io/sci-tech/>Sci-Tech</a></li><li class=nav-item><a class=nav-link href=https://zxdawn.github.io/essay/>Essay</a></li><li class=nav-item><a class=nav-link href=https://zxdawn.github.io/about/>About</a></li></ul></div></div></nav><div id=site-header class="carousel slide carousel-fade" data-ride=carousel style=height:18rem><div class=carousel-inner role=listbox><div class="carousel-item active"><div class=view style=background-image:url(https://zxdawn.github.io/img/header-slides/0.jpg);background-repeat:no-repeat;background-size:cover><div class="mask rgba-black-light d-flex justify-content-center align-items-center"></div></div></div><div class=carousel-item><div class=view style=background-image:url(https://zxdawn.github.io/img/header-slides//1.jpg);background-repeat:no-repeat;background-size:cover><div class="mask rgba-black-light d-flex justify-content-center align-items-center"></div></div></div><div class=carousel-item><div class=view style=background-image:url(https://zxdawn.github.io/img/header-slides//2.jpg);background-repeat:no-repeat;background-size:cover><div class="mask rgba-black-light d-flex justify-content-center align-items-center"></div></div></div><div class=carousel-item><div class=view style=background-image:url(https://zxdawn.github.io/img/header-slides//3.jpg);background-repeat:no-repeat;background-size:cover><div class="mask rgba-black-light d-flex justify-content-center align-items-center"></div></div></div><div class=carousel-item><div class=view style=background-image:url(https://zxdawn.github.io/img/header-slides//4.jpg);background-repeat:no-repeat;background-size:cover><div class="mask rgba-black-light d-flex justify-content-center align-items-center"></div></div></div></div><div class="carousel-content text-center white-text wow fadeIn"><div class="row mx-0 headfont mt-3 pt-4"><div class="col-12 col-sm-5 align-middle"><a href=https://zxdawn.github.io><img class="pull-right avatar avatar-md" src=https://zxdawn.github.io/img/me.jpg alt></a></div><div class="col-12 col-sm-7 text-left pl-2"><a href=https://zxdawn.github.io><h1 class="mb-2 h1" style=font-weight:300><strong>Dreambooker</strong></h1></a><div class=mt-2 style=font-size:1rem;color:#fff><a href=//github.com/zxdawn target=_blank rel="noopener me"><i class="fab fa-github pr-1" aria-hidden=true></i></a>
<a href=//twitter.com/zhangxin_dawn target=_blank rel="noopener me"><i class="fab fa-twitter pr-1" aria-hidden=true></i></a>
<a href=//instagram.com/zhangxin_dawn/ target=_blank rel="noopener me"><i class="fab fa-instagram pr-1" aria-hidden=true></i></a>
<a href=mailto:xinzhang1215@gmail.com><i class="far fa-envelope-open pr-1" aria-hidden=true></i></a></div></div></div></div></div><main class=post-main-wrapper><div class=row><div class=col-md-10><div class="z-depth-1 post-wrapper white-bg single-post dont-break-out"><div class="post-header text-center"><ul class="post-meta li-x"><li><a href=https://zxdawn.github.io/categories/sci-tech><i class="fas fa-folder-open pr-1" aria-hidden=true></i> sci-tech</a></li></ul><div class="px-4 post-heading">Initializing the WRF model with ECMWF ERA-Interim reanalysis</div><ul class="post-meta li-x mt-1"><li>Dec 20, 2017</li><li class=middot></li><li>2 minute read</li></ul><div class=view><img src=https://zxdawn.github.io/images/sci-tech/2017-12/ECMWF.png></div></div><div class="post-content markdown"><h2 id=summarization>Summarization</h2><blockquote><p>To summarise, you need three separate data files from the reanalysis data:</p><ol><li>Pressure level data (or model levels)</li><li>Surface variable data</li><li>Fixed data.</li></ol></blockquote><h2 id=downloading-the-data-via-python-script>Downloading the data via Python script</h2><p>You’ll be required to select which surface varibles you want to download, as well as which pressure levels, too. The land-sea mask is just a single file. According to <a href="http://bbs.06climate.com/forum.php?mod=viewthread&tid=30962&extra=&page=1">夏朗的芒果</a>, we just need to download UNGRIB - Required Fields</p><blockquote><p>The details of the <a href=https://software.ecmwf.int/wiki/display/WEBAPI/Access+ECMWF+Public+Datasets>Python API are here</a>, it’s well explained so I will only summarise here what you need to do:</p><ol><li>Register on the ECMWF site</li><li>Download an access key to placed on the computer or system you are downloading to.</li><li>Install the ecmwfapi Python module.</li><li>Either write your own python script using the API documentation above, or have the ECMWF web interface generate one for you. (Click the ‘view MARS request’ after making your selections, and then copy the Python script that is displayed. An example python script looks like this:</li></ol></blockquote><h3 id=plpy>pl.py</h3><pre tabindex=0><code>from ecmwfapi import ECMWFDataServer
server = ECMWFDataServer()

server.retrieve({
          &#39;class&#39;   : &#34;ei&#34;,
          &#39;dataset&#39; : &#34;interim&#34;,
          &#39;expver&#39;  : &#34;1&#34;,
          &#39;step&#39;    : &#34;0&#34;,
          &#39;stream&#39;  : &#34;oper&#34;,
          &#39;number&#39;  : &#34;all&#34;,
          &#39;levtype&#39; : &#34;pl&#34;,
          &#39;levelist&#39;: &#34;10/20/30/50/70/100/125/150/200/250/300/350/400/450/500/550/600/650/700/750/800/850/900/925/950/975/1000&#34;,
          &#39;date&#39;    : &#34;20150806/to/20150809&#34;,
          &#39;time&#39;    : &#34;00/06/12/18&#34;,
          &#39;origin&#39;  : &#34;all&#34;,
          &#39;type&#39;    : &#34;an&#34;,
          &#39;param&#39;   : &#34;129.128/133.128/131.128/132.128/130.128/157.128&#34;,
          &#39;grid&#39;    : &#34;0.75/0.75&#34;,
          &#39;target&#39;  : &#34;ERA-Int_pl_20150806_20150809_0.75.grib&#34;
          })
</code></pre><h3 id=sfcpy>sfc.py</h3><pre tabindex=0><code>from ecmwfapi import ECMWFDataServer
server = ECMWFDataServer()

server.retrieve({
          &#34;class&#34;: &#34;ei&#34;,
          &#39;dataset&#39; : &#34;interim&#34;,
          &#34;expver&#34;: &#34;1&#34;,
          &#39;step&#39;    : &#34;0&#34;,
          &#39;stream&#39;  : &#34;oper&#34;,
          &#39;class&#39;   : &#34;ei&#34;,
          &#39;number&#39;  : &#34;all&#34;,
          &#39;levtype&#39; : &#34;sfc&#34;,
          &#39;date&#39;    : &#34;20150806/to/20150809&#34;,
          &#39;time&#39;    : &#34;00/06/12/18&#34;,
          &#39;type&#39;    : &#34;an&#34;,
          &#39;param&#39;   : &#34;134.128/151.128/235.128/167.128/165.128/166.128/168.128/34.128/31.128/141.128/139.128/170.128/183.128/236.128/39.128/40.128/41.128/42.128/33.128&#34;,
          &#39;grid&#39;    : &#34;0.75/0.75&#34;,
          &#39;target&#39;  : &#34;ERA-Int_sfc_20150806_20150809_0.75.grib&#34;
          })
</code></pre><h3 id=fixpy>fix.py</h3><pre tabindex=0><code>from ecmwfapi import ECMWFDataServer
server = ECMWFDataServer()
server.retrieve({
    &#34;class&#34;: &#34;ei&#34;,
    &#34;dataset&#34;: &#34;interim&#34;,
    &#34;date&#34;: &#34;1989-01-01&#34;,
    &#34;expver&#34;: &#34;1&#34;,
    &#34;grid&#34;: &#34;0.75/0.75&#34;,
    &#34;levtype&#34;: &#34;sfc&#34;,
    &#34;param&#34;: &#34;129.128/172.128&#34;,
    &#34;step&#34;: &#34;0&#34;,
    &#34;stream&#34;: &#34;oper&#34;,
    &#34;time&#34;: &#34;12:00:00&#34;,
    &#34;type&#34;: &#34;an&#34;,
    &#34;target&#34;: &#34;ERA_inv.grib&#34;,
})
</code></pre><p>ECMWF provide the data in two different file formats, GRIB (gridded-binary) and netCDF (.nc files). WPS comes with the ungribber tool (ungrib.exe) so I’ve gone for the grib data format here. (Selected by default in the Python download script).</p><h2 id=ungribbing-the-data>Ungribbing the data</h2><p>Now we need to ‘ungrib’ data to convert into the WPS intermediate file format, before running metgrid. This has to be done in two stages - one for the surface and pressure level data, and one for the land-sea mask. This is because the land-sea mask has a ‘start date’ of 1989-01-01 if you try to run ungrib with the date of your case study, ungrib will fail, complaining that the dates specified could not be found.</p><p>Link the correct Vtable to the file name “Vtable” in the directory. The Vtable can be found in<code>WPS/ungrib/Variable_Tables/Vtable.ECMWF</code></p><ol><li><p>Link GRIB files to the correct file names in the run directory.</p><pre tabindex=0><code>./link_grib.csh ERA-Int_pl_20150806_20150809_0.75.grib
</code></pre></li><li><p>Ungribbing the pressure level data.In the namelist.wps file, I set the the <code>&ungrib</code> section to the following:</p><pre tabindex=0><code>out_format = &#39;WPS&#39;,
prefix = &#39;PL&#39;
</code></pre><pre tabindex=0><code>./ungrib.exe
</code></pre></li><li><p>Repeat again for the surface data:</p><pre tabindex=0><code>./link_grib.csh ERA-Int_sfc_20150806_20150809_0.75.grib
</code></pre><pre tabindex=0><code>out_format = &#39;WPS&#39;,
prefix = &#39;SFC&#39;
</code></pre><pre tabindex=0><code>./ungrib.exe
</code></pre></li><li><p>Repeat again for the fixed data:</p><pre tabindex=0><code>start_date = &#39;1989-01-01_12:00:00&#39;,&#39;1989-01-01_12:00:00&#39;,
end_date   = &#39;1989-01-01_12:00:00&#39;,&#39;1989-01-01_12:00:00&#39;,
.
.
.
out_format = &#39;WPS&#39;,
prefix = &#39;FIX&#39;
</code></pre><pre tabindex=0><code>./ungrib.exe
</code></pre></li><li><p>You should have these files now:</p><pre tabindex=0><code>FIX:1989-01-01_12  PL:2015-08-07_12  PL:2015-08-08_06   SFC:2015-08-07_06  SFC:2015-08-08_00
PL:2015-08-07_00   PL:2015-08-07_18  PL:2015-08-08_12   SFC:2015-08-07_12  SFC:2015-08-08_06
PL:2015-08-07_06   PL:2015-08-08_00  SFC:2015-08-07_00  SFC:2015-08-07_18  SFC:2015-08-08_12
</code></pre></li></ol><h2 id=metgrid>Metgrid</h2><p>If you are using the sea surface temparatures field from the ECMWF data, you’ll need to make a few changes to the <code>METGRID.TBL</code> file for it to correctly interpolate and mask the sea surface temparatures around land. In the <code>METGRID.TBL</code> file (located in <code>WPS/metgrid/</code>), change the entry of the SST field to the following:</p><pre tabindex=0><code>SST
  interp_option=sixteen_pt+four_pt+wt_average_4pt+wt_average_16pt+search
  missing_value=-1.E30
  masked=land
  interp_mask=LANDMASK(1)
  fill_missing=0.
  flag_in_output=FLAG_SST 
</code></pre><p>The changes are to make the interp_mask use the LANDMASK mask instead of LANDSEA (the default), and to change the interpolation option slightly. Without the changes, <a href=http://dvalts.io/modelling/data/2016/12/23/ECMWF-data-in-WRF.html>Declan</a> found that for his inner domain the sea surface temperatures were incorrectly masked, and had been interpolated over land as well. Although metgrid.exe did not complain when run, the met files generated caused an error when real.exe was run - generating an error message saying:</p><pre tabindex=0><code>-------------- FATAL CALLED ---------------
FATAL CALLED FROM FILE:  &lt;stdin&gt;  LINE:    2970
mismatch_landmask_ivgtyp
-------------------------------------------
</code></pre><p>The changes to METGRID.TBL should remedy this error message.</p><p>Before running metgrid, there is one last change to make to the namelist.wps file:</p><pre tabindex=0><code>&amp;share
 start_date = &#39;2015-08-07_00:00:00&#39;,&#39;2015-08-07_00:00:00&#39;,
 end_date   = &#39;2015-08-08_12:00:00&#39;,&#39;2015-08-08_12:00:00&#39;,
&amp;metgrid
 fg_name = &#39;PL&#39;,&#39;SFC&#39;,
 constants_name = &#39;FIX:1989-01-01_12&#39;,
 io_form_metgrid = 2,
</code></pre><pre tabindex=0><code>./metgrid.exe
</code></pre><blockquote><p>Declan:</p><p>Hopefully it will produce all the input met files needed, and correctly interpolated. It’s a good idea before running real.exe and wrf.exe to check that the fields look reasonable. In particular, check the SST field if you are using sea-surface temperatures. Check the nested domains as well - I found that my SST field had been incorrectly interpolated in the inner domain, which required the change to the METGRID.TBL file above. Ncview is a useful utility for checking the met files generated by metgrid.</p></blockquote><h2 id=references>References</h2><ol><li><a href=http://dvalts.io/modelling/data/2016/12/23/ECMWF-data-in-WRF.html>Initialising the WRF model with ECMWF ERA-20C reanalysis data</a></li><li><a href="http://bbs.06climate.com/forum.php?mod=viewthread&tid=30962&extra=&page=1">06climate</a></li></ol></div><div class=row><div class=col-md-8><div class=mb-5><div class="li-x div-x post-meta"><li class=pr-0><a href=https://zxdawn.github.io/tags/><i class="fas fa-tags"></i></a></li><div class=tags-sm><li><a href=https://zxdawn.github.io/tags/wrf-chem role=button>WRF-Chem</a></li><li><a href=https://zxdawn.github.io/tags/era role=button>ERA</a></li></div></div></div></div></div><div class="row pt-3"><div class=col-md-6><a href=https://zxdawn.github.io/2017/12/10/wrf-chem-mozcart-and-wrf_tips/ class=post-meta>Previous<div class="pt-2 pb-5 d-flex"><i class="fas fa-angle-left text-grey font-weight-bold mr-2 active-color"></i>
<span>WRF-Chem (MOZCART) and WRF_tips</span></div></a></div><div class="col-md-6 text-right"><a href=https://zxdawn.github.io/2018/01/18/remarkable-connecting-to-a-hotspot-which-supports-circumvention/ class=post-meta>Next<div class="pt-2 pb-5 flex-reverse"><i class="fas fa-angle-right text-grey font-weight-bold ml-2 active-color"></i>
<span>Remarkable - Connecting to a hotspot which supports circumvention</span></div></a></div></div></div></div><div class="col-md-2 pl-0"><div id=page-scrollspy class=toc-nav><ul class="nav nav-pills ml-0"><li class="nav-item pb-3 text-center"><span class="font-weight-bold mb-2">- CATALOG -</span></li><ul class=nav><li class=nav-item><a class=nav-link href=#summarization>Summarization</a></li></ul><ul class=nav><li class=nav-item><a class=nav-link href=#downloading-the-data-via-python-script>Downloading the data via Python script</a></li></ul><ul class=nav><ul class=nav><li class=nav-item><a class=nav-link href=#plpy>pl.py</a></li></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class=nav-link href=#sfcpy>sfc.py</a></li></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class=nav-link href=#fixpy>fix.py</a></li></ul></ul><ul class=nav><li class=nav-item><a class=nav-link href=#ungribbing-the-data>Ungribbing the data</a></li></ul><ul class=nav><li class=nav-item><a class=nav-link href=#metgrid>Metgrid</a></li></ul><ul class=nav><li class=nav-item><a class=nav-link href=#references>References</a></li></ul></ul></div></div></div></main><footer class="page-footer text-center font-small mt-4 wow fadeIn"><div class="pb-2 mt-5 pt-5"><a href=//github.com/zxdawn target=_blank rel="noopener me"><i class="fab fa-github pr-1" aria-hidden=true></i></a>
<a href=//twitter.com/zhangxin_dawn target=_blank rel="noopener me"><i class="fab fa-twitter pr-1" aria-hidden=true></i></a>
<a href=//instagram.com/zhangxin_dawn/ target=_blank rel="noopener me"><i class="fab fa-instagram pr-1" aria-hidden=true></i></a>
<a href=mailto:xinzhang1215@gmail.com><i class="far fa-envelope-open pr-1" aria-hidden=true></i></a></div><div class="copyright py-4"><span>2016 - 2022 &copy; | Theme <a href=https://github.com/EliiseS/AllinOne target=_blank>AllinOne</a></span></div></footer><script type=text/javascript src=https://zxdawn.github.io/js/vendors/jquery/jquery-3.3.1.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/vendors/jquery/jquery.smooth-scroll.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/vendors/popper.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/vendors/holder.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/vendors-extensions/bootstrap4/bootstrap.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/vendors/mdb/mdb.min.js></script>
<script type=text/javascript src=https://zxdawn.github.io/js/main.js></script>
<script src=https://zxdawn.github.io/js/vendors/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script type=text/javascript>(new WOW).init()</script></body></html>